# 第二章 什么是API设计模式

> 本章涵盖：
> - 什么是API设计模式
> - 为什么API设计模式很重要
> - 解构API设计模式
> - 使用设计模式和不使用设计模式来设计API的差异

现在，我们已经了解了API是什么以及什么是“好”的API，我们可以继续探讨在构建API时如何应用不同的模式。我们将从探讨API设计模式是什么，为什么它们很重要，以及我们将如何在后续章节中解析这些模式。最后，我们将查看一个示例API，看看如何使用预构建的API设计模式可以节省大量时间和避免潜在的麻烦。

## 什么是API设计模式

在我们开始探讨API设计模式之前，我们需要打下一些基础。首先从一个简单的问题开始：什么是设计模式？如果我们注意到软件设计是指为了解决问题而编写的一些代码的结构或布局，那么软件设计模式是指特定的设计可以反复应用于许多类似的软件问题，只需要进行小的调整以适应不同的情境。这意味着该模式不是我们用来解决单个问题的预构建库，而更像是解决相似结构问题的蓝图。

如果这听起来太抽象，让我们来具体化一下，想象一下我们想在后院建一个小屋。有几种不同的选择，从几百年前的做法到如今由Lowe's和Home Depot等公司提供的现代化专业方法。有很多选择，但有四种常见的选择，如下所示：

1. 购买预制的小屋并放在后院。
2. 购买小屋套件（设计图纸和材料）并自己组装。
3. 购买一套小屋的设计图，根据需要修改设计，然后自己建造。
4. 从头开始设计和建造整个小屋。

如果我们将这些与它们的软件等效物联系起来，它们将从使用现成的现成软件包一直到编写完全定制的系统来解决问题。在表2.1中，我们可以看到随着列表项目从上到下，这些选项会变得越来越困难，但从一个选项到下一个会增加越来越多的灵活性。换句话说，难度最低的灵活性最小，而难度最大的灵活性最大。

<small>表2.1 建造小屋和构建软件系统方式的类比</small>

| 选项 | 困难度 | 灵活度 | 对应的软件构件选项 |
| --- | --- | --- | --- |
| 购买预制的小屋 | 简单 | 无 | 直接使用现成的软件包 |
| 购买套件组装 | 比较简单 | 很小 | 自定义现成的软件包 |
| 按照现成设计图建造 | 一般 | 一般 | 从设计文档开始构建 |
| 从头设计并建造 | 困难 | 最大 | 从头设计软件系统并构建 |

软件工程师大多数情况下倾向于选择“从头开始构建”的选项。有时这是必要的，特别是在我们解决的问题是新问题的情况下。其他情况下，这个选择在成本效益分析中胜出，因为我们的问题与易用选项有足够的不同。还有一些情况下，我们可能已经知道一个库恰好解决了我们的问题（或者足够接近），因此我们选择依赖已经解决类似问题的工具。事实证明，选择介于中间的选项（定制现有软件或根据设计文档进行构建）不太常见，但却应该经常使用并会获得很好的效果。这就是设计模式的应用之处。

从上层看，设计模式是应用于软件的“按设计图纸构建”的选项。就像小屋的设计图包括尺寸、门窗的位置以及屋顶的材料一样，设计模式包括我们编写的代码的某些规格和细节。在软件中，这通常意味着指定代码的高级布局以及依赖布局来解决特定设计问题的细微差别。然而，很少有设计模式是为了完全独立使用而生的。大多数情况下，设计模式侧重于特定的组件而不是整个系统。换句话说，设计图侧重于单个方面（比如屋顶形状）或组件（比如窗户设计），而不是整个小屋。乍看之下，这可能看起来不太好，但只有在目标确实是建造一个小屋的情况下才是如此。如果您尝试构建与小屋类似但不完全相同的东西，那么拥有每个单独组件的设计图意味着您可以将它们组合在一起，精确地构建出您想要的东西，选择屋顶形状A和窗户设计B。这也适用于我们的设计模式讨论，因为每个设计模式通常侧重于系统的单个组件或问题类型，通过组装许多预设计的组件，帮助您构建出您想要的东西。

例如，如果您想要向系统添加调试日志记录，您可能只希望有一种方法来记录消息。有很多方法可以做到这一点（例如，使用一个单一的全局变量），但偶然间有一个设计模式旨在解决这个软件问题。这个模式在经典著作《设计模式》（Gamma等人，1994）中有所描述，被称为单例模式（singleton），它确保只创建一个类的实例。这个“设计图”要求一个类具有私有构造函数和一个名为`getInstance()`的静态方法，该方法总是返回该类的单个实例（只有在它还不存在的情况下才创建该单个实例）。这个模式本身不是全部（毕竟，拥有一个什么都不做的单例类有什么用呢？）；但是，它是在需要解决这个小型问题的情况下要遵循的一个经过明确定义和经过充分测试的模式，即始终有一个类的单个实例。

现在我们知道了通常的软件设计模式是什么，我们必须问一个问题：什么是API设计模式？根据第1章中对API的描述，API设计模式只是将软件设计模式应用于API而不是所有软件。这意味着API设计模式与普通设计模式一样，只是用于设计和构建API的方法的蓝图。由于重点是接口而不是实现，在大多数情况下，API设计模式将专注于接口，而不一定会构建实现。虽然大多数API设计模式通常不会详细说明这些接口的底层实现，但有时它们会规定API行为的某些方面。例如，一个API设计模式可能会指定某个RPC可以是最终一致的（eventually consistent），这意味着从该RPC返回的数据可能会略有过时（例如，它可能会从缓存中读取而不是从存储系统中读取）。

在后面的章节中，我们将更详细地解释我们计划如何记录API模式，但首先让我们快速看看为什么我们应该关心API设计模式。

## 2.2 为什么API设计模式很重要

API设计模式之所以有用，类似于在建造小屋时使用设计图，是因为它们充当我们可以在项目中使用的预先设计的基本模块。然而，我们并没有深入探讨为什么我们需要这些预先设计的图纸。难道我们不足够聪明，可以构建出良好的API吗？难道我们不是最了解我们的业务和技术问题吗？虽然这通常是正确的，但事实是，当设计API时，我们用来构建非常精心设计的软件的一些技术在很大程度上无法奏效。特别是，敏捷开发过程特别推崇的迭代方法在设计API时很难应用。为了理解原因，我们必须探讨软件系统的两个方面。首先，我们必须研究各种接口的灵活性（或刚性），然后必须了解接口的受众对我们的变更和整体设计迭代产生的影响。让我们从灵活性（flexibility）开始。

正如我们在第1章中所看到的，API是一种特殊的接口，主要用于计算系统相互交互。尽管以编程方式访问系统非常有价值，但它也更加脆弱，因为接口的变更很容易导致使用接口的人发生故障。例如，在API中更改字段的名称将导致用户使用旧名称编写的代码发生故障。从API服务器的角度来看，旧代码正在使用一个不再存在的名称请求某个内容。这与其他类型的接口（例如图形用户界面（GUI））非常不同，后者主要由人类而不是计算机使用，因此更能够抵御变化。这意味着尽管变更可能令人不悦，但通常不会导致灾难性故障，使我们完全无法使用接口。例如，更改网页上按钮的颜色或位置可能会很丑陋和不方便，但我们仍然可以弄清楚如何使用接口来完成我们需要做的事情。

通常，我们将接口的这个方面称为其灵活性，即用户可以轻松适应变化的接口是灵活的，而即使是小的变更（例如重命名字段）也会导致完全失败的接口是刚性（rigid）的。这个区别很重要，因为接口是否能够进行大量变化在很大程度上取决于接口的灵活性。最重要的是，我们可以看到刚性接口使我们难以像在其他软件项目中一样向完美的设计不断迭代。这意味着我们通常会被困在设计决策中，无论是好的还是坏的。这可能让你认为API的刚性意味着我们永远无法使用迭代式开发流程。但实际上情况并不总是这样，这要归功于接口的另一个重要方面：可见性（visibility）。

通常，我们可以将大多数接口分为两种不同的类别：用户可以看到和互动的接口（在软件中通常称为前端），以及他们无法看到的接口（通常称为后端）。例如，当我们打开浏览器时，可以轻松看到Facebook的图形用户界面；但是，我们无法看到Facebook如何存储我们的社交图和其他数据。为了对这个可见性方面使用更正式的术语，我们可以说前端（所有用户都可以看到和互动的部分）通常被认为是公共的（public），而后端（只对较小的内部人员组可见）被认为是私有的（private）。这个区别很重要，因为它在一定程度上决定了我们对不同种类的接口（特别是刚性的API）进行变更的能力。

如果我们对公共接口进行变更，整个世界都会看到它，并可能会受到它的影响。由于受众如此之大，粗心地进行变更可能会导致用户沮丧或愤怒。尽管这当然适用于刚性接口，比如API，但它同样适用于灵活的接口。例如，在Facebook的早期，大多数主要功能或设计变更都会在几周内引起大学生的愤怒。但是，如果接口不是公共的，对只有某个内部小组的成员可见的后端接口进行变更是否也很重要？在这种情况下，受变更影响的用户数量要小得多，甚至可能仅限于同一个团队或同一办公室的人员，因此似乎我们重新获得了更多自由来进行变更。这是个好消息，因为这意味着我们应该能够快速迭代朝着理想设计前进，同时应用敏捷原则。

那么，为什么API是特殊的呢？事实证明，当我们设计许多API（根据定义是刚性的）并与世界分享时，实际上存在两个方面（刚性和变更困难）的最坏情况。这意味着进行变更要比这两个属性的任何其他组合更加困难。

<small>表2.2 接口变更的困难度</small>

| 灵活性 | 手中 | 示例接口 | 变更困难度 |
| --- | --- | --- | --- |
| 购买预制的小屋 | 简单 | 无 | 直接使用现成的软件包 |
| 购买套件组装 | 比较简单 | 很小 | 自定义现成的软件包 |
| 按照现成设计图建造 | 一般 | 一般 | 从设计文档开始构建 |
| 从头设计并建造 | 困难 | 最大 | 从头设计软件系统并构建 |

简而言之，这种“两者兼具”的情况（既刚性又难以变更）使得可重复使用且经得起考验的设计模式对于构建API比其他类型的软件更为重要。在大多数软件项目中，代码通常是私有的，但API中的设计决策则是明显可见的，展示给服务的所有用户。由于这严重限制了我们对设计进行渐进性改进的能力，而依赖已经经受时间考验的现有模式会非常有价值——力争在第一次就做对事情而不是像在大多数软件中最终做对事情。

既然我们已经探讨了这些设计模式之所以重要的原因，让我们通过解构并探索它的各个组成部分来深入了解API设计模式。

## 2.3 解构API设计模式

## 2.4 案例研究: Twapi，一个类似Twitter的API

## 本章总结
